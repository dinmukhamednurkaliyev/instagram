name: "Continuous Deployment"

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  release-android:
    name: "Release / Android"
    runs-on: ubuntu-latest
    steps:
      - name: "Repo: Checkout"
        uses: actions/checkout@v6.0.1

      - name: "Action: Flutter Setup"
        uses: ./.github/actions/flutter_setup
        with:
          version: "3.38.9"
          channel: "stable"

      - name: "Build: Android Bundle"
        run: flutter build appbundle --release

  ship-google-play:
    name: "Ship / Google Play"
    needs: [release-android]
    runs-on: ubuntu-latest
    steps:
      - name: "Store: Upload Bundle"
        run: echo "Uploading to Google Play..."

  ship-github:
    name: "Ship / GitHub Release"
    needs: [ship-google-play]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    steps:
      - name: "Repo: Checkout"
        uses: actions/checkout@v6.0.1

      - name: "Git: Tag & Release"
        uses: softprops/action-gh-release@v2.5.0
        with:
          tag_name: ${{ github.ref_name || format('v0.0.{0}', github.run_number) }}
          name: "Release ${{ github.ref_name || format('v0.0.{0}', github.run_number) }}"
          files: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
          draft: false
          prerelease: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }

  deployment-gate:
    name: "Ship / Status"
    runs-on: ubuntu-latest
    if: always()
    needs:
      - release-android
      - ship-google-play
      - ship-github
    steps:
      - name: "Gate: Evaluate Status"
        shell: bash
        run: |
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          NC='\033[0m'

          RESULTS='${{ toJSON(needs.*.result) }}'

          if echo "$RESULTS" | grep -qE 'failure|cancelled'; then
            echo -e "${RED}❌ ERROR: Deployment failed.${NC}"
            exit 1
          fi

          echo -e "${GREEN}✅ SUCCESS: App shipped to all platforms.${NC}"
